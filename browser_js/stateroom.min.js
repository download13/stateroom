!function(){function t(t){e(this),this.id=null,this._localState=Object.create(null),this._members=Object.create(null),this._ws=t;var i=this;t.onopen=function(){i._flushLocalState(),t.onmessage=function(t){try{var e=JSON.parse(t.data)}catch(s){return void console.error("Invalid JSON sent from StateRoom server: "+t.data)}var o=e[0],r=e[1],a=e[2];i._handleCmd(o,r,a)}}}function e(t){function e(t,e){return o[t]||(o[t]=[]),o[t].push(e),this}function i(t,e){var i=o[t];if(i)if(e){var s=i.indexOf(e);-1!==s&&i.splice(s,1)}else delete o[t];return this}function s(t){var e=[].slice.call(arguments,1),i=o[t];return i&&i.forEach(function(t){t.apply(null,e)}),this}var o={};t.on=e,t.off=i,t.emit=s}var i=0,s=1,o=2,r=3,a=4;t.prototype.set=function(t,e){this._localState[t]=e,this._flushLocalState()},t.prototype["delete"]=function(t){t in this._localState&&(this._localState[t]=void 0),this._flushLocalState()},t.prototype.clear=function(){this._localState=Object.create(null),this._sendCmd(a)},t.prototype._flushLocalState=function(){this._ws.readyState===this._ws.OPEN&&Object.keys(this._localState).forEach(function(t){var e=this._localState[t];void 0===e?this._sendCmd(r,[t]):this._sendCmd(o,[t,e]),delete this._localState[t]},this)},t.prototype._sendCmd=function(t,e){this._ws.send(JSON.stringify([t,e]))},t.prototype._handleCmd=function(t,e,n){if(t)switch(e){case o:this._setProperty(t,n);break;case r:this._deleteProperty(t,n);break;case a:this._members[t]=Object.create(null),this.emit("clear",t)}else switch(e){case i:this.id?this._addMember(n[0]):(this.id=n[0],this.emit("ready"));break;case s:this._removeMember(n[0])}},t.prototype._addMember=function(t){this._members[t]=Object.create(null),this.emit("join",t)},t.prototype._removeMember=function(t){delete this._members[t],this.emit("part",t)},t.prototype._setProperty=function(t,e){var i=e[0],s=e[1];this._members[t][i]=s,this.emit("set",t,i,s)},t.prototype._deleteProperty=function(t,e){var i=e[0],s=this._members[t],o=s[i];delete s[i],this.emit("delete",t,i,o)},window.StateRoom=t}();